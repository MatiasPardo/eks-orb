version: 2.1

orbs:
  orb-tools: circleci/orb-tools@3.0.0

executors:
  cli:
    resource_class: small
    docker:
      - image: circleci/circleci-cli

jobs:
  validate:
    executor: cli
    steps:
      - checkout
      - orb-tools/validate:
          orb-path: src/orb.yml

  production-publish:
    executor: cli
    steps:
      - checkout
      - run: circleci orb publish promote tiendanube/eks@dev:${CIRCLE_BRANCH} patch --token $CIRCLE_TOKEN

workflows:
  btd:
    jobs:
      - validate
      - promote-dev:
          type: approval
          requires:
            - validate
      - orb-tools/publish:
          context: orbs
          name: dev-publish
          orb-path: src/orb.yml
          orb-ref: tiendanube/eks@dev:${CIRCLE_BRANCH}
          validate: false
          requires:
            - promote-dev
      - promote-production:
          type: approval
          requires:
            - dev-publish
      - production-publish:
          context: orbs
          requires:
            - promote-production
